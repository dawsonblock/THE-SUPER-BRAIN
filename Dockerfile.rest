# syntax=docker/dockerfile:1.7
FROM ubuntu:24.04 AS builder
RUN --mount=type=cache,target=/var/cache/apt,sharing=locked \
    --mount=type=cache,target=/var/lib/apt,sharing=locked \
    apt-get update && apt-get install -y --no-install-recommends \
    build-essential \
    cmake \
    git \
    python3-dev \
    python3-pip \
    ccache \
    ninja-build \
    && rm -rf /var/lib/apt/lists/*

# Configure ccache
ENV CCACHE_DIR=/ccache
RUN mkdir -p /ccache

WORKDIR /opt/build
COPY brain-ai /opt/build/brain-ai

RUN --mount=type=cache,target=/ccache \
    cd brain-ai && \
    mkdir -p build && cd build && \
    cmake -DCMAKE_BUILD_TYPE=Release \
          -DCMAKE_C_COMPILER_LAUNCHER=ccache \
          -DCMAKE_CXX_COMPILER_LAUNCHER=ccache \
          -GNinja .. && \
    cmake --build . -j$(nproc)

FROM python:3.12-slim
ENV PYTHONDONTWRITEBYTECODE=1 PYTHONUNBUFFERED=1
RUN --mount=type=cache,target=/var/cache/apt,sharing=locked \
    --mount=type=cache,target=/var/lib/apt,sharing=locked \
    apt-get update && apt-get install -y --no-install-recommends curl && \
    rm -rf /var/lib/apt/lists/*
RUN adduser --uid 1001 --disabled-password --gecos "" brain

WORKDIR /srv/app
COPY brain-ai-rest-service /srv/app/brain-ai-rest-service
ENV PYTHONPATH=/srv/app/brain-ai-rest-service:${PYTHONPATH}
# Copy the entire python output directory to ensure module availability across platforms
COPY --from=builder /opt/build/brain-ai/build/python /srv/app/brain-ai-rest-service/python
# Ensure pybind output directory exists and place the module in a predictable path
RUN set -e; \
    mkdir -p /srv/app/brain-ai-rest-service/python && \
    if ls /srv/app/brain-ai-rest-service/python/brain_ai_core*.so >/dev/null 2>&1; then \
      cp /srv/app/brain-ai-rest-service/python/brain_ai_core*.so /srv/app/brain-ai-rest-service/; \
    else \
      echo "Warning: brain_ai_core module not found; REST will run in pure-Python fallback mode"; \
    fi

RUN --mount=type=cache,target=/root/.cache/pip \
    pip install --no-cache-dir -r brain-ai-rest-service/requirements.txt

ENV SAFE_MODE=1 \
    LLM_STUB=1 \
    EMBEDDINGS_BACKEND=cpu \
    API_KEY=devkey \
    REQUIRE_API_KEY_FOR_WRITES=1

USER brain
EXPOSE 5001 9090
CMD ["uvicorn", "app.app_v2:app", "--host", "0.0.0.0", "--port", "5001"]
