name: CI Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:

env:
  CMAKE_VERSION: 3.22.0
  PYTHON_VERSION: 3.12

jobs:
  # Linting and code quality checks
  lint:
    name: Lint and Format Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install pre-commit
        run: pip install pre-commit

      - name: Cache pre-commit environments
        uses: actions/cache@v4
        with:
          path: ~/.cache/pre-commit
          key: pre-commit-${{ hashFiles('.pre-commit-config.yaml') }}

      - name: Run pre-commit hooks
        run: pre-commit run --all-files

  # C++ build and test
  test-cpp:
    name: C++ Build and Test
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-24.04, macos-latest]
        build_type: [Release, Debug]
    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies (Ubuntu)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential cmake ninja-build ccache libssl-dev

      - name: Install dependencies (macOS)
        if: runner.os == 'macOS'
        run: |
          brew install cmake ninja ccache openssl

      - name: Setup ccache
        uses: hendrikmuhs/ccache-action@v1.2
        with:
          key: ${{ matrix.os }}-${{ matrix.build_type }}

      - name: Configure CMake
        working-directory: brain-ai
        run: |
          mkdir -p build
          cd build
          cmake -DCMAKE_BUILD_TYPE=${{ matrix.build_type }} \
                -DCMAKE_C_COMPILER_LAUNCHER=ccache \
                -DCMAKE_CXX_COMPILER_LAUNCHER=ccache \
                -DBUILD_TESTS=ON \
                -DBUILD_PYTHON_BINDINGS=OFF \
                -GNinja ..

      - name: Build
        working-directory: brain-ai/build
        run: |
          JOBS=1
          if command -v nproc >/dev/null 2>&1; then
            JOBS="$(nproc)"
          elif command -v sysctl >/dev/null 2>&1; then
            JOBS="$(sysctl -n hw.ncpu || echo 1)"
          fi
          ninja -j "${JOBS}"

      - name: Run C++ tests
        working-directory: brain-ai/build
        run: ctest --output-on-failure

  # Python REST service tests
  test-python:
    name: Python Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r brain-ai-rest-service/requirements.txt
          pip install pytest pytest-asyncio pytest-cov

      - name: Run Python tests
        working-directory: brain-ai-rest-service
        run: |
              name: python-coverage
              fail_ci_if_error: true
              token: ${{ secrets.CODECOV_TOKEN }}

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          files: ./brain-ai-rest-service/coverage.xml
          flags: python
          name: python-coverage

  # Frontend build and test
  test-frontend:
    name: Frontend Build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: brain-ai-gui/package-lock.json

      - name: Install dependencies
        working-directory: brain-ai-gui
        run: npm ci

      - name: Type check
        working-directory: brain-ai-gui
        run: npm run type-check

      - name: Lint
        working-directory: brain-ai-gui
        run: npm run lint

      - name: Build
        working-directory: brain-ai-gui
        run: npm run build

  # Integration tests
  test-integration:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: [test-cpp, test-python]
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r brain-ai-rest-service/requirements.txt
          pip install pytest pytest-asyncio

      - name: Run integration tests
        run: |
          python test_integration_full.py

  # Docker build test
  build-docker:
    name: Build Docker Images
    runs-on: ubuntu-latest
    needs: [lint, test-cpp, test-python]
    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Cache Docker layers
        uses: actions/cache@v4
        with:
          path: /tmp/.buildx-cache
          key: ${{ runner.os }}-buildx-${{ github.ref }}-${{ hashFiles('**/Dockerfile.rest', '**/requirements.txt', 'brain-ai/CMakeLists.txt') }}
          restore-keys: |
            ${{ runner.os }}-buildx-${{ github.ref }}-
            ${{ runner.os }}-buildx-

      - name: Build REST service image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile.rest
          push: false
          tags: brain-ai-rest:latest
          cache-from: type=local,src=/tmp/.buildx-cache
          cache-to: type=local,dest=/tmp/.buildx-cache-new,mode=max

      # Temp fix for cache growth
      - name: Move cache
        run: |
          rm -rf /tmp/.buildx-cache
          mv /tmp/.buildx-cache-new /tmp/.buildx-cache

  # Summary job
  ci-success:
    name: CI Success
    runs-on: ubuntu-latest
    needs: [lint, test-cpp, test-python, test-frontend, test-integration, build-docker]
    if: always()
    steps:
      - name: Check all jobs
        run: |
          if [ "${{ needs.lint.result }}" != "success" ] || \
             [ "${{ needs.test-cpp.result }}" != "success" ] || \
             [ "${{ needs.test-python.result }}" != "success" ] || \
             [ "${{ needs.test-frontend.result }}" != "success" ] || \
             [ "${{ needs.test-integration.result }}" != "success" ] || \
             [ "${{ needs.build-docker.result }}" != "success" ]; then
            echo "One or more jobs failed"
            exit 1
          fi
          echo "All CI jobs passed successfully!"
